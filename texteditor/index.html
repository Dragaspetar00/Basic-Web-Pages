<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dragaspetar Text Editor (.dspx)</title>
<meta name="color-scheme" content="light dark" />
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/fflate@0.8.2/umd/index.js"></script>
<style>
  :root{
    --bg: #0f1115;
    --panel: #171a21;
    --text: #e6e9ef;
    --muted: #9aa4b2;
    --accent: #4da3ff;
    --accent-2: #7cc0ff;
    --danger: #ff6b6b;
    --ok: #3ad29f;
    --shadow: 0 8px 24px rgba(0,0,0,.25);
    --radius: 12px;
  }
  [data-theme="light"]{
    --bg: #f6f7fb;
    --panel: #ffffff;
    --text: #111318;
    --muted: #54606e;
    --accent: #2f74ff;
    --accent-2: #77a6ff;
    --danger: #e24a4a;
    --ok: #1aa874;
    --shadow: 0 8px 24px rgba(16,24,40,.10);
  }
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  .app{
    display:grid;grid-template-rows:auto auto 1fr auto;min-height:100dvh;gap:10px;
    max-width:1400px;margin:0 auto;padding:12px;
  }
  header{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
  }
  .brand{display:flex;align-items:center;gap:10px;font-weight:700}
  .brand .badge{background:var(--accent);color:#fff;padding:2px 8px;border-radius:999px;font-size:12px}
  .toolbar{
    position:sticky;top:0;z-index:50;background:var(--panel);
    border-radius:var(--radius);box-shadow:var(--shadow);padding:8px 10px;
  }
  .ribbon{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .group{display:flex;gap:6px;align-items:center;border-right:1px solid #00000022;padding-right:8px}
  .group:last-child{border-right:none}
  button, .btn{
    appearance:none;border:1px solid #0000;background:#1b1f29;color:var(--text);
    padding:8px 10px;border-radius:8px;cursor:pointer;
    transition:.15s transform, .15s background;
  }
  [data-theme="light"] button{background:#f3f6ff;border-color:#dfe7ff}
  button:hover{transform:translateY(-1px);background:#2a2f3b}
  [data-theme="light"] button:hover{background:#e7eeff}
  .btn-accent{background:var(--accent);color:#fff}
  .btn-danger{background:var(--danger);color:#fff}
  .btn-ghost{background:transparent;border:1px solid #ffffff22}
  input[type="file"]{display:none}
  .main{
    display:grid;grid-template-columns:1fr 320px;gap:12px;min-height:0;
  }
  .editor{
    background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);min-height:0;display:flex;flex-direction:column;
  }
  textarea{
    flex:1;padding:18px 20px;background:transparent;color:var(--text);
    border:none;outline:none;resize:none;font: 15px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", "Courier New", monospace;
    tab-size:2;white-space:pre-wrap;word-break:break-word;
  }
  .stats{
    background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px;display:flex;flex-direction:column;gap:10px;min-height:0;
  }
  .stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .card{background:#00000010;padding:10px;border-radius:10px}
  .muted{color:var(--muted);font-size:12px}
  .bar{height:8px;background:#ffffff12;border-radius:999px;overflow:hidden}
  .bar > span{display:block;height:100%;background:var(--accent);width:0%}
  .list{max-height:160px;overflow:auto}
  .status{display:flex;justify-content:space-between;align-items:center;gap:8px;color:var(--muted);font-size:12px}
  .status .dot{width:8px;height:8px;border-radius:50%}
  .dot.ok{background:var(--ok)} .dot.warn{background:var(--danger)}
  .pill{background:#00000020;border-radius:999px;padding:2px 8px;font-size:12px}
  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:20px}
  .modal-inner{background:var(--panel);border-radius:12px;box-shadow:var(--shadow);min-width:280px;max-width:520px;width:100%;padding:16px;display:flex;flex-direction:column;gap:10px}
  .modal input, .modal select{
    width:100%;padding:10px;border-radius:8px;border:1px solid #ffffff22;background:#0f131a;color:var(--text)
  }
  [data-theme="light"] .modal input{background:#fff;border-color:#dfe3ea}
  .modal .actions{display:flex;justify-content:flex-end;gap:8px}
  @media (max-width: 900px){
    .main{grid-template-columns:1fr}
    .ribbon{gap:6px}
    .group{border-right:none}
  }
</style>
</head>
<body data-theme="dark">
<div class="app">
  <header>
    <div class="brand">
      <span>Dragaspetar Text Editor</span>
      <span class="badge">.dspx</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="themeBtn" class="btn-ghost" title="Tema">ğŸŒ™/â˜€ï¸</button>
      <span id="autosaveState" class="pill">Otomatik kaydediliyorâ€¦</span>
    </div>
  </header>

  <div class="toolbar">
    <div class="ribbon">
      <div class="group">
        <button id="newBtn" title="Temizle (Ctrl+N)" class="btn-danger">Yeni</button>
        <label class="btn">
          AÃ§ (.dspx)
          <input type="file" id="openFile" accept=".dspx,application/vnd.dragaspetar.dspx" />
        </label>
        <button id="saveDspxBtn" class="btn-accent" title="Kaydet .dspx (Ctrl+S)">Kaydet .dspx</button>
        
      </div>
      <div class="group">
        <button id="upperBtn" title="BÃœYÃœK (Alt+U)">BÃœYÃœK</button>
        <button id="lowerBtn" title="kÃ¼Ã§Ã¼k (Alt+L)">kÃ¼Ã§Ã¼k</button>
        <button id="titleBtn" title="BaÅŸ Harf (Alt+T)">BaÅŸ Harf</button>
        <button id="cleanBtn" title="BoÅŸluklarÄ± temizle (Ctrl+/)">Temizle</button>
      </div>
      <div class="group">
        <button id="copyBtn" title="Panoya kopyala">Kopyala</button>
        <button id="findBtn" title="Bul (Ctrl+F)">Bul</button>
        <button id="replaceBtn" title="DeÄŸiÅŸtir (Ctrl+H)">DeÄŸiÅŸtir</button>
      </div>
      <div class="group">
        <button id="darkBtn" class="btn-ghost">Koyu/AÃ§Ä±k</button>
        <button id="wrapBtn" class="btn-ghost" title="SatÄ±r kaydÄ±rma">KaydÄ±r: AÃ§Ä±k</button>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="editor">
      <textarea id="editor" placeholder="Yazmaya baÅŸlayÄ±nâ€¦"></textarea>
    </div>
    <aside class="stats">
      <div class="stat-grid">
        <div class="card">
          <div class="muted">Kelime</div>
          <div id="words" style="font-size:20px;font-weight:700">0</div>
        </div>
        <div class="card">
          <div class="muted">Karakter (boÅŸluklu)</div>
          <div id="chars" style="font-size:20px;font-weight:700">0</div>
        </div>
        <div class="card">
          <div class="muted">Karakter (boÅŸluksuz)</div>
          <div id="charsNo" style="font-size:20px;font-weight:700">0</div>
        </div>
        <div class="card">
          <div class="muted">CÃ¼mle</div>
          <div id="sentences" style="font-size:20px;font-weight:700">0</div>
        </div>
        <div class="card">
          <div class="muted">Paragraf</div>
          <div id="paras" style="font-size:20px;font-weight:700">0</div>
        </div>
        <div class="card">
          <div class="muted">Okuma sÃ¼resi</div>
          <div id="readTime" style="font-size:20px;font-weight:700">0 sn</div>
        </div>
      </div>
      <div class="card">
        <div class="muted">Okunabilirlik</div>
        <div id="readability" style="font-weight:700;margin:6px 0">-</div>
        <div class="bar"><span id="readBar"></span></div>
      </div>
      <div class="card">
        <div class="muted">SeÃ§ili metin</div>
        <div id="selStats">0 kelime Â· 0 karakter</div>
      </div>
      <div class="card">
        <div class="muted">En Ã§ok kullanÄ±lan kelimeler</div>
        <div id="topWords" class="list"></div>
      </div>
    </aside>
  </div>

  <div class="status">
    <div style="display:flex;align-items:center;gap:8px">
      <span class="dot ok" id="saveDot"></span>
      <span id="statusText">HazÄ±r</span>
    </div>
    <div>
      <span class="muted">KÄ±sayollar: Ctrl+S .dspx Â· Ctrl+Shift+S .txt Â· Ctrl+F Â· Ctrl+H Â· Alt+U/L/T Â· Ctrl+/</span>
    </div>
  </div>
</div>

<!-- Bul/DeÄŸiÅŸtir Modal -->
<div id="findModal" class="modal" aria-hidden="true">
  <div class="modal-inner">
    <strong>Bul & DeÄŸiÅŸtir</strong>
    <input id="findInput" placeholder="Bulâ€¦" />
    <input id="replaceInput" placeholder="Åununla deÄŸiÅŸtirâ€¦" />
    <label class="muted" style="display:flex;align-items:center;gap:8px">
      <input type="checkbox" id="caseChk" />BÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf duyarlÄ±
    </label>
    <div class="actions">
      <button id="findNextBtn">Bul</button>
      <button id="replaceOneBtn">DeÄŸiÅŸtir</button>
      <button id="replaceAllBtn" class="btn-accent">TÃ¼mÃ¼nÃ¼ DeÄŸiÅŸtir</button>
      <button id="closeFindBtn" class="btn-ghost">Kapat</button>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const ta = $('#editor');
  const autosaveState = $('#autosaveState');
  const saveDot = $('#saveDot');
  const statusText = $('#statusText');
  const wrapBtn = $('#wrapBtn');
  const themeBtn = $('#themeBtn');
  const darkBtn = $('#darkBtn');

  // Local state
  let dirty = false;
  let wrapOn = true;
  let theme = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  document.body.dataset.theme = theme;

  // Restore autosave
  const saved = localStorage.getItem('dspx_text');
  if(saved) ta.value = saved;

  // UI updates
  const numFmt = n => n.toLocaleString('tr-TR');
  const debounce = (fn, ms=200)=>{let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms)}};
  const TURKISH_STOP = new Set([
    've','veya','ile','ya','yada','ya da','bir','bu','ÅŸu','o','da','de','mi','mÄ±','mu','mÃ¼',
    'iÃ§in','gibi','Ã§ok','az','ama','fakat','ki','ise','en','hem','Ã§Ã¼nkÃ¼','daha','her','hiÃ§',
    'ne','neden','nasÄ±l','nerede','hangi','ben','sen','o','biz','siz','onlar','ÅŸey','olan','olarak','var','yok',
    'ile','diye','dahi','bile','keza','ile','mÄ±','mi','mu','mÃ¼','de','da'
  ]);

  function getStats(text){
    const chars = text.length;
    const charsNo = text.replace(/\s/g,'').length;
    const wordsArr = (text.match(/\p{L}+(?:'\p{L}+)?/gu) || []);
    const words = wordsArr.length;
    const sentences = (text.match(/[^.!?â€¦]+[.!?â€¦]+(\s|$)/g) || (text.trim()? [text] : [])).length;
    const paras = (text.split(/\n{2,}/).filter(p=>p.trim().length>0)).length || (text.trim()?1:0);
    const readSec = Math.max(1, Math.round((words/200)*60));

    // Readability: basit sezgisel skor
    const avgWPS = sentences ? (words/sentences) : (words?words:0);
    const avgCPW = words ? (charsNo/words) : 0;
    let score = 0;
    // DÃ¼ÅŸÃ¼k skor daha kolay â€“ ters Ã§evirip 0..100 arasÄ± normalize edelim:
    //  ideal ~ 12 sÃ¶zcÃ¼k/cÃ¼mle ve ~5-6 char/kelime civarÄ±
    const s1 = Math.max(0, 30 - Math.abs(12 - avgWPS)*3);  // 0..30
    const s2 = Math.max(0, 30 - Math.abs(5.5 - avgCPW)*8); // 0..30
    const s3 = Math.min(40, Math.max(0, 40 - Math.log10(Math.max(1, words))*10)); // 0..40
    score = Math.min(100, s1+s2+s3);
    let label = 'Orta';
    if(score >= 70) label = 'Kolay';
    else if(score < 40) label = 'Zor';

    return { chars, charsNo, words, sentences, paras, readSec, readability:{score,label} };
  }

  function updateStats(){
    const text = ta.value;
    const s = getStats(text);
    $('#words').textContent = numFmt(s.words);
    $('#chars').textContent = numFmt(s.chars);
    $('#charsNo').textContent = numFmt(s.charsNo);
    $('#sentences').textContent = numFmt(s.sentences);
    $('#paras').textContent = numFmt(s.paras);
    $('#readTime').textContent = s.readSec < 60 ? `${s.readSec} sn` : `${Math.floor(s.readSec/60)} dk ${s.readSec%60} sn`;
    $('#readability').textContent = `${s.readability.label} (${Math.round(s.readability.score)}/100)`;
    $('#readBar').style.width = `${s.readability.score}%`;

    // En Ã§ok kullanÄ±lan kelimeler (stopword filtreli)
    const tokens = (ta.value.toLocaleLowerCase('tr').match(/\p{L}+/gu) || []).filter(w => !TURKISH_STOP.has(w) && w.length>=2);
    const freq = new Map();
    for(const t of tokens){ freq.set(t, (freq.get(t)||0)+1); }
    const top = [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
    const total = tokens.length || 1;
    const ul = document.createElement('div');
    for(const [w,c] of top){
      const pct = Math.min(100, Math.round((c/total)*100*4)); // gÃ¶rsel iÃ§in bÃ¼yÃ¼t
      const row = document.createElement('div');
      row.style.display='grid'; row.style.gridTemplateColumns='1fr auto'; row.style.gap='8px'; row.style.alignItems='center'; row.style.margin='4px 0';
      row.innerHTML = `<span>${w}</span><span class="muted">${c}</span>`;
      const bar = document.createElement('div');
      bar.className='bar'; bar.style.marginTop='4px';
      const span = document.createElement('span'); span.style.width = pct+'%';
      bar.appendChild(span);
      const wrapper = document.createElement('div');
      wrapper.appendChild(row); wrapper.appendChild(bar);
      ul.appendChild(wrapper);
    }
    const tw = $('#topWords');
    tw.innerHTML=''; tw.appendChild(ul);

    // SeÃ§ili metin
    updateSelectionStats();
  }

  function updateSelectionStats(){
    const start = ta.selectionStart, end = ta.selectionEnd;
    const sel = ta.value.slice(start, end);
    const words = (sel.match(/\p{L}+(?:'\p{L}+)?/gu) || []).length;
    $('#selStats').textContent = `${numFmt(words)} kelime Â· ${numFmt(sel.length)} karakter`;
  }

  const saveLocal = debounce(()=>{
    localStorage.setItem('dspx_text', ta.value);
    autosaveState.textContent = 'Kaydedildi (tarayÄ±cÄ±)';
    saveDot.className = 'dot ok';
  }, 400);

  ta.addEventListener('input', ()=>{
    dirty = true;
    saveDot.className = 'dot warn';
    statusText.textContent = 'DÃ¼zenleniyorâ€¦';
    autosaveState.textContent = 'Otomatik kaydediliyorâ€¦';
    updateStats();
    saveLocal();
  });
  ta.addEventListener('select', updateSelectionStats);

  // Initial render
  updateStats();

  // Tools
  const toUpper = s => s.toLocaleUpperCase('tr');
  const toLower = s => s.toLocaleLowerCase('tr');
  const toTitle = s => s.replace(/\p{L}[\p{L}'â€™\-]*/gu, w=>{
    const low = w.toLocaleLowerCase('tr'); return low[0]?.toLocaleUpperCase('tr') + low.slice(1);
  });
  const cleanWhitespace = s => {
    return s
      .replace(/[ \t]+/g,' ')       // Ã§oklu boÅŸluk -> tek boÅŸluk
      .replace(/[ \t]+\n/g,'\n')    // satÄ±r sonu boÅŸluklarÄ±nÄ± kaldÄ±r
      .replace(/\n{3,}/g,'\n\n')    // 2+ boÅŸ satÄ±rÄ± 1 boÅŸ satÄ±ra indir
      .trim();
  }

  function replaceSelection(fn){
    const start = ta.selectionStart, end = ta.selectionEnd;
    const before = ta.value.slice(0,start);
    const mid = ta.value.slice(start,end);
    const after = ta.value.slice(end);
    const next = before + fn(mid || ta.value) + after;
    ta.value = next;
    ta.focus();
    updateStats();
    saveLocal();
  }

  $('#upperBtn').onclick = ()=> replaceSelection(toUpper);
  $('#lowerBtn').onclick = ()=> replaceSelection(toLower);
  $('#titleBtn').onclick = ()=> replaceSelection(toTitle);
  $('#cleanBtn').onclick = ()=> { ta.value = cleanWhitespace(ta.value); updateStats(); saveLocal(); };
  $('#copyBtn').onclick = async ()=> { await navigator.clipboard.writeText(ta.value); statusText.textContent='Panoya kopyalandÄ±'; };

  // Wrap toggle
  wrapBtn.onclick = ()=>{
    wrapOn = !wrapOn;
    ta.style.whiteSpace = wrapOn ? 'pre-wrap' : 'pre';
    wrapBtn.textContent = `KaydÄ±r: ${wrapOn?'AÃ§Ä±k':'KapalÄ±'}`;
  };

  // Theme
  function setTheme(t){ document.body.dataset.theme = t; localStorage.setItem('theme', t); }
  themeBtn.onclick = darkBtn.onclick = ()=> setTheme(document.body.dataset.theme==='dark' ? 'light' : 'dark');

  // Find/Replace
  const findModal = $('#findModal');
  const findInput = $('#findInput');
  const replaceInput = $('#replaceInput');
  const caseChk = $('#caseChk');

  function openFind(){ findModal.style.display='flex'; findModal.setAttribute('aria-hidden','false'); findInput.focus(); }
  function closeFind(){ findModal.style.display='none'; findModal.setAttribute('aria-hidden','true'); ta.focus(); }

  $('#findBtn').onclick = openFind;
  $('#replaceBtn').onclick = openFind;
  $('#closeFindBtn').onclick = closeFind;

  function findNext(){
    const q = findInput.value;
    if(!q) return;
    const text = ta.value;
    const start = ta.selectionEnd || 0;
    const flags = caseChk.checked ? 'g' : 'gi';
    const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), flags);
    re.lastIndex = start;
    const m = re.exec(text) || re.exec(text.slice(0, start));
    if(m){
      const idx = m.index + (m.input===text ? 0 : 0);
      ta.focus();
      ta.setSelectionRange(idx, idx+m[0].length);
      ta.scrollTop = ta.scrollHeight * (idx/text.length);
    }
  }
  function replaceOne(){
    if(ta.selectionStart === ta.selectionEnd){ findNext(); return; }
    const repl = replaceInput.value ?? '';
    const start = ta.selectionStart, end = ta.selectionEnd;
    ta.setRangeText(repl, start, end, "end");
    updateStats(); saveLocal();
  }
  function replaceAll(){
    const q = findInput.value; if(!q) return;
    const repl = replaceInput.value ?? '';
    const flags = caseChk.checked ? 'g' : 'gi';
    const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), flags);
    ta.value = ta.value.replace(re, repl);
    updateStats(); saveLocal();
  }

  $('#findNextBtn').onclick = findNext;
  $('#replaceOneBtn').onclick = replaceOne;
  $('#replaceAllBtn').onclick = replaceAll;

  // Keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    if(e.ctrlKey && e.key.toLowerCase()==='s'){ e.preventDefault(); saveAsDspx(); }
    if(e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='s'){ e.preventDefault(); saveAsTxt(); }
    if(e.ctrlKey && e.key.toLowerCase()==='f'){ e.preventDefault(); openFind(); }
    if(e.ctrlKey && e.key.toLowerCase()==='h'){ e.preventDefault(); openFind(); }
    if(e.altKey && e.key.toLowerCase()==='u'){ e.preventDefault(); replaceSelection(toUpper); }
    if(e.altKey && e.key.toLowerCase()==='l'){ e.preventDefault(); replaceSelection(toLower); }
    if(e.altKey && e.key.toLowerCase()==='t'){ e.preventDefault(); replaceSelection(toTitle); }
    if(e.ctrlKey && e.key==='/'){ e.preventDefault(); ta.value = cleanWhitespace(ta.value); updateStats(); saveLocal(); }
    if(e.ctrlKey && e.key.toLowerCase()==='n'){ e.preventDefault(); newDoc(); }
    if(e.key==='Escape' && findModal.getAttribute('aria-hidden')==='false'){ e.preventDefault(); closeFind(); }
  });

  $('#newBtn').onclick = newDoc;
  function newDoc(){
    if(ta.value && !confirm('Metni temizlemek istediÄŸine emin misin?')) return;
    ta.value=''; updateStats(); saveLocal(); statusText.textContent='Yeni dosya';
  }

  // Download helpers
  function dl(filename, blob){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }

  function saveAsTxt(){
    dl('document.txt', new Blob([ta.value], {type:'text/plain;charset=utf-8'}));
    statusText.textContent='TXT indirildi';
    dirty = false; saveDot.className='dot ok';
  }
  $('#saveTxtBtn').onclick = saveAsTxt;

  // .dspx format v1: DSPX(4) | ver(1)=1 | flags(1) | reserved(2) | salt(16) | iv(12) | origLen(4) | ciphertext(...)
  const MAGIC = new TextEncoder().encode('DSPX');
  const MIME = 'application/vnd.dragaspetar.dspx';

  async function deriveKeyPBKDF2(passwordBytes, salt){
    const keyMat = await crypto.subtle.importKey('raw', passwordBytes, 'PBKDF2', false, ['deriveKey']);
    return crypto.subtle.deriveKey(
      { name:'PBKDF2', salt, iterations: 250000, hash: 'SHA-256' },
      keyMat, { name:'AES-GCM', length: 256 }, false, ['encrypt','decrypt']
    );
  }

  async function encodeDSPX(text, password){
    const enc = new TextEncoder();
    const raw = enc.encode(text);
    const comp = fflate.compressSync(raw, { level: 6 });

    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const key = await deriveKeyPBKDF2(enc.encode(password), salt);

    // Header (40 bytes)
    const header = new Uint8Array(40);
    header.set(MAGIC, 0);
    header[4] = 1; // version
    header[5] = 0b00000010; // flags: bit1 => AES-GCM, bit0 => deflate (0=deflate default)
    header[6] = 0; header[7] = 0; // reserved
    header.set(salt, 8);
    header.set(iv, 24);
    new DataView(header.buffer).setUint32(36, raw.length, true);
    const aad = header.slice(0, 16);

    const cipherBuf = await crypto.subtle.encrypt({name:'AES-GCM', iv, additionalData: aad}, key, comp);
    const cipher = new Uint8Array(cipherBuf);

    const fileBytes = new Uint8Array(header.length + cipher.length);
    fileBytes.set(header, 0);
    fileBytes.set(cipher, header.length);

    return new Blob([fileBytes], {type: MIME});
  }

  async function decodeDSPX(buf, password){
    const view = new Uint8Array(buf);
    if(view.length < 40) throw new Error('Dosya Ã§ok kÃ¼Ã§Ã¼k');
    if(view[0]!==77||view[1]!==83||view[2]!==80||view[3]!==88){ // 'DSPX'
      // 68 83 80 88? Wait 'D'=68. But we used 'DSPX' which is 68,83,80,88
    }
    // safer check using TextDecoder:
    const magic = new TextDecoder().decode(view.slice(0,4));
    if(magic!=='DSPX') throw new Error('GeÃ§ersiz dosya (magic)');

    const version = view[4]; if(version!==1) throw new Error('SÃ¼rÃ¼m desteklenmiyor');
    const flags = view[5];
    const salt = view.slice(8, 24);
    const iv = view.slice(24, 36);
    const origLen = new DataView(view.buffer, view.byteOffset+36, 4).getUint32(0, true);
    const aad = view.slice(0, 16);
    const cipher = view.slice(40);

    const enc = new TextEncoder();
    const key = await deriveKeyPBKDF2(enc.encode(password), salt);
    let comp;
    try{
      const plain = await crypto.subtle.decrypt({name:'AES-GCM', iv, additionalData: aad}, key, cipher);
      comp = new Uint8Array(plain);
    }catch(e){
      throw new Error('Åifre hatalÄ± veya dosya bozuk');
    }
    const raw = fflate.decompressSync(comp);
    const text = new TextDecoder().decode(raw);
    if(origLen && raw.length !== origLen){
      // UyuÅŸmazlÄ±k durumunda yine de dÃ¶ndÃ¼rÃ¼yoruz, sadece bilgi:
      console.warn('Uzunluk uyuÅŸmazlÄ±ÄŸÄ±', raw.length, origLen);
    }
    return text;
  }

  async function saveAsDspx(){
    const password = prompt('Bu .dspx dosyasÄ± iÃ§in parola belirleyin (boÅŸ bÄ±rakÄ±rsanÄ±z kaydedilmez):', localStorage.getItem('dspx_default_pw')||'');
    if(password==null) return;
    if(!password){ alert('GÃ¼venlik iÃ§in parola Ã¶nerilir.'); }
    try{
      const blob = await encodeDSPX(ta.value, password || 'dragaspetar-default');
      const name = `document_${new Date().toISOString().replace(/[:.]/g,'-')}.dspx`;
      dl(name, blob);
      statusText.textContent='DSPX kaydedildi';
      dirty=false; saveDot.className='dot ok';
      if(password) localStorage.setItem('dspx_default_pw', password);
    }catch(e){
      console.error(e);
      alert('Kaydetme sÄ±rasÄ±nda hata: '+e.message);
    }
  }
  $('#saveDspxBtn').onclick = saveAsDspx;

  // Open .dspx
  $('#openFile').addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const password = prompt('Dosya parolasÄ±nÄ± girin:', localStorage.getItem('dspx_default_pw')||'');
    try{
      const buf = await f.arrayBuffer();
      const text = await decodeDSPX(buf, password || 'dragaspetar-default');
      ta.value = text; updateStats(); saveLocal();
      statusText.textContent = `AÃ§Ä±ldÄ±: ${f.name}`;
      dirty=false; saveDot.className='dot ok';
    }catch(err){
      alert('AÃ§Ä±lÄ±rken hata: '+err.message);
    }finally{
      e.target.value = '';
    }
  });

  // Drag & drop aÃ§ma
  document.addEventListener('dragover', e=>{ e.preventDefault(); });
  document.addEventListener('drop', async e=>{
    e.preventDefault();
    const file = [...(e.dataTransfer?.files||[])].find(f=>f.name.endsWith('.dspx'));
    if(!file) return;
    const pw = prompt('Dosya parolasÄ±nÄ± girin:', localStorage.getItem('dspx_default_pw')||'');
    try{
      const buf = await file.arrayBuffer();
      const text = await decodeDSPX(buf, pw || 'dragaspetar-default');
      ta.value = text; updateStats(); saveLocal();
      statusText.textContent = `AÃ§Ä±ldÄ±: ${file.name}`;
    }catch(err){ alert('AÃ§Ä±lamadÄ±: '+err.message); }
  });

})();
</script>
</body>
</html>